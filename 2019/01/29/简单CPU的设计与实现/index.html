<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="longfangsong"><title>简单CPU的设计与实现 · Blog</title><meta name="description" content="本文假设读者会基本的verilog。
 hexo-inject:begin  hexo-inject:end 本文会实现一个CPU的原理装置，作者对几乎所有内容进行了大量的简化，以便于理解，但所制作的简易CPU能完成大部分功能。
设计思路传统CPU的控制往往较为复杂，有多种多样的微操作，但本文设计的"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon-precomposed" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 4.2.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Blog</a></h3><div class="description"><p>生命是灰色的，而理论之树常青</p></div></div><div id="pirate" data-wordart-src="//cdn.wordart.com/json/685czi4rqil5" style="width: 100%;" data-wordart-show-attribution></div><script src="//cdn.wordart.com/wordart.min.js" async defer></script></div><ul class="social-links"><li><a href="http://github.com/longfangsong" target="_blank" rel="noopener"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me" target="_blank" rel="noopener"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole" target="_blank" rel="noopener"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/tags">标签</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h1><a>简单CPU的设计与实现</a></h1></div><div class="post-content"><p>本文假设读者会基本的verilog。</p>
 hexo-inject:begin  hexo-inject:end <p>本文会实现一个CPU的原理装置，作者对几乎所有内容进行了大量的简化，以便于理解，但所制作的简易CPU能完成大部分功能。</p>
<h2 id="设计思路"><a class="headerlink" href="#设计思路" title="设计思路"></a>设计思路</h2><p>传统CPU的控制往往较为复杂，有多种多样的微操作，但本文设计的CPU只有下面几种“微操作”，且一定是按照这个顺序执行，即：</p>
<ul>
<li>根据PC寄存器的值直接从指令Cache取出指令并利用<strong>组合逻辑</strong>进行译码<sup><a href="#fn_1" id="reffn_1">1</a></sup></li>
<li>将1到2个数据从某处连入ALU</li>
<li>将ALU运算结果输出到某处</li>
</ul>
<p>即：</p>
<p><img alt="design" src="./design.svg"/></p>
<p>用这个方式实现的CPU仍然有所有必须的功能，且非常容易理解。</p>
<h2 id="最简单的计算"><a class="headerlink" href="#最简单的计算" title="最简单的计算"></a>最简单的计算</h2><p>CPU能做的事情无非是计算和控制，其中计算比较容易实现。</p>
<p>CPU中主要的计算部件，学过计组的人都知道，是ALU。</p>
<p>ALU 不过是一个简单的组合逻辑电路，实现如下：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ALU(</span><br/><span class="line">  <span class="keyword">input</span> <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] input1,                <span class="comment">// 操作数1</span></span><br/><span class="line">  <span class="keyword">input</span> <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] input2,                <span class="comment">// 操作数2</span></span><br/><span class="line">  <span class="keyword">input</span> <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] func,                  <span class="comment">// 功能选择</span></span><br/><span class="line">  <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>] result = <span class="number">8'b00000000</span>   <span class="comment">// 结果</span></span><br/><span class="line">);</span><br/><span class="line">    <span class="keyword">parameter</span> ADD  = <span class="number">3'b000</span>,</span><br/><span class="line">              SUB  = <span class="number">3'b001</span>,</span><br/><span class="line">              OR   = <span class="number">3'b010</span>,</span><br/><span class="line">              AND  = <span class="number">3'b011</span>,</span><br/><span class="line">              <span class="comment">// 100和101保留</span></span><br/><span class="line">              NOT  = <span class="number">3'b110</span>,</span><br/><span class="line">              HLT  = <span class="number">3'b111</span>;</span><br/><span class="line">    <span class="keyword">always</span> @(input1 <span class="keyword">or</span> input2 <span class="keyword">or</span> func) <span class="keyword">begin</span></span><br/><span class="line">      <span class="keyword">case</span>(func)</span><br/><span class="line">        ADD : result = input1 + input2;</span><br/><span class="line">        SUB : result = input1 - input2;</span><br/><span class="line">        OR  : result = input1 | input2;</span><br/><span class="line">        AND : result = input1 &amp; input2;</span><br/><span class="line">        NOT : result = ~input1;</span><br/><span class="line">        HLT : result = input1;</span><br/><span class="line">      <span class="keyword">endcase</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">endmodule</span></span><br/></pre></td></tr></table></figure>
<h2 id="寄存器堆"><a class="headerlink" href="#寄存器堆" title="寄存器堆"></a>寄存器堆</h2><p>要计算，当然要有用来计算的数据，还要存放运算结果的地方。</p>
<p>一般来说大部分计算数据的来源和运输结果的去向都是寄存器。</p>
<p>很多计算都有两个输入和一个输出，所以我们的寄存器堆要有两组输出，每组输出由(输出寄存器编号,输出数据线)和一组输入(输入寄存器编号,输入数据线)。</p>
<p>相应verilog代码如下：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> RegisterFile(</span><br/><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> read_clk,            <span class="comment">// 此时钟信号上升沿时从寄存器中读取</span></span><br/><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> write_clk,           <span class="comment">// 此时钟信号上升沿时向寄存器中写入</span></span><br/><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] read_address1, <span class="comment">// 要读取的地址1</span></span><br/><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] read_address2, <span class="comment">// 要读取的地址2</span></span><br/><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>] out_1,         <span class="comment">// 读取的输出</span></span><br/><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>] out_2,         <span class="comment">// 读取的输入</span></span><br/><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] write_address, <span class="comment">// 要写入的地址</span></span><br/><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] in,            <span class="comment">// 要写入的值</span></span><br/><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> in_en                <span class="comment">// 写入使能</span></span><br/><span class="line">);</span><br/><span class="line">    <span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>] data [<span class="number">7</span>:<span class="number">0</span>];           <span class="comment">// 寄存器们</span></span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] reg0;</span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] reg1;</span><br/><span class="line">    <span class="keyword">assign</span> reg0 = data[<span class="number">0</span>];</span><br/><span class="line">    <span class="keyword">assign</span> reg1 = data[<span class="number">1</span>];</span><br/><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> read_clk) <span class="keyword">begin</span></span><br/><span class="line">        <span class="keyword">case</span> (read_address1)</span><br/><span class="line">          <span class="number">'h0</span>: out_1 &lt;= data[<span class="number">0</span>];</span><br/><span class="line">          <span class="number">'h1</span>: out_1 &lt;= data[<span class="number">1</span>];</span><br/><span class="line">          <span class="number">'h2</span>: out_1 &lt;= data[<span class="number">2</span>];</span><br/><span class="line">          <span class="number">'h3</span>: out_1 &lt;= data[<span class="number">3</span>];</span><br/><span class="line">          <span class="number">'h4</span>: out_1 &lt;= data[<span class="number">4</span>];</span><br/><span class="line">          <span class="number">'h5</span>: out_1 &lt;= data[<span class="number">5</span>];</span><br/><span class="line">          <span class="number">'h6</span>: out_1 &lt;= data[<span class="number">6</span>];</span><br/><span class="line">          <span class="number">'h7</span>: out_1 &lt;= data[<span class="number">7</span>];</span><br/><span class="line">        <span class="keyword">endcase</span></span><br/><span class="line">        <span class="keyword">case</span> (read_address2)</span><br/><span class="line">          <span class="number">'h0</span>: out_2 &lt;= data[<span class="number">0</span>];</span><br/><span class="line">          <span class="number">'h1</span>: out_2 &lt;= data[<span class="number">1</span>];</span><br/><span class="line">          <span class="number">'h2</span>: out_2 &lt;= data[<span class="number">2</span>];</span><br/><span class="line">          <span class="number">'h3</span>: out_2 &lt;= data[<span class="number">3</span>];</span><br/><span class="line">          <span class="number">'h4</span>: out_2 &lt;= data[<span class="number">4</span>];</span><br/><span class="line">          <span class="number">'h5</span>: out_2 &lt;= data[<span class="number">5</span>];</span><br/><span class="line">          <span class="number">'h6</span>: out_2 &lt;= data[<span class="number">6</span>];</span><br/><span class="line">          <span class="number">'h7</span>: out_2 &lt;= data[<span class="number">7</span>];</span><br/><span class="line">        <span class="keyword">endcase</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> write_clk) <span class="keyword">begin</span></span><br/><span class="line">        <span class="keyword">if</span> (in_en) <span class="keyword">begin</span></span><br/><span class="line">            <span class="keyword">case</span>(write_address)</span><br/><span class="line">                <span class="number">'h0</span>: data[<span class="number">0</span>] &lt;= in;</span><br/><span class="line">                <span class="number">'h1</span>: data[<span class="number">1</span>] &lt;= in;</span><br/><span class="line">                <span class="number">'h2</span>: data[<span class="number">2</span>] &lt;= in;</span><br/><span class="line">                <span class="number">'h3</span>: data[<span class="number">3</span>] &lt;= in;</span><br/><span class="line">                <span class="number">'h4</span>: data[<span class="number">4</span>] &lt;= in;</span><br/><span class="line">                <span class="number">'h5</span>: data[<span class="number">5</span>] &lt;= in;</span><br/><span class="line">                <span class="number">'h6</span>: data[<span class="number">6</span>] &lt;= in;</span><br/><span class="line">                <span class="number">'h7</span>: data[<span class="number">7</span>] &lt;= in;</span><br/><span class="line">            <span class="keyword">endcase</span></span><br/><span class="line">        <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">endmodule</span></span><br/></pre></td></tr></table></figure>
<h2 id="最简单的控制与指令系统"><a class="headerlink" href="#最简单的控制与指令系统" title="最简单的控制与指令系统"></a>最简单的控制与指令系统</h2><p>我们来设计一个简单到不能再简单的指令系统：</p>
<h3 id="指令格式"><a class="headerlink" href="#指令格式" title="指令格式"></a>指令格式</h3><p><img alt="instruction" src="./instruction.png"/></p>
<p>（你可能已经看出来了，寄存器到寄存器的MOV其实就是“运算为不运算”的运算指令）</p>
<h3 id="程序计数器"><a class="headerlink" href="#程序计数器" title="程序计数器"></a>程序计数器</h3><p>为了方便起见，我们暂时不和RAM/ROM或是FLASH进行对接，而是手动实现一个简单的ROM，将程序代码放在里面：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> ROM(</span><br/><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] read_address,</span><br/><span class="line">    <span class="keyword">output</span> <span class="keyword">reg</span> [<span class="number">15</span>:<span class="number">0</span>] result</span><br/><span class="line">);</span><br/><span class="line">    <span class="keyword">always</span> @(read_address) <span class="keyword">begin</span></span><br/><span class="line">        <span class="keyword">case</span> (read_address)</span><br/><span class="line">            <span class="number">'h00</span>: result &lt;= <span class="number">'h1111</span>;            <span class="comment">// 留空</span></span><br/><span class="line">            <span class="number">'h01</span>: result &lt;= <span class="number">'hB833</span>;     <span class="comment">// R0 = 33</span></span><br/><span class="line">            <span class="number">'h02</span>: result &lt;= <span class="number">'hB911</span>;     <span class="comment">// R1 = 11</span></span><br/><span class="line">            <span class="number">'h03</span>: result &lt;= <span class="number">'h0004</span>;     <span class="comment">// R0 = R0 + R1</span></span><br/><span class="line">                    <span class="number">'h04</span>: result &lt;= <span class="number">'hF803</span>;     <span class="comment">// JMP 03</span></span><br/><span class="line">        <span class="keyword">endcase</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line"><span class="keyword">endmodule</span></span><br/></pre></td></tr></table></figure>
<p>而程序计数器就只不过是一个普通的<code>reg [7:0]</code>，放入<code>read_address</code>就能得到要执行的指令。</p>
<h3 id="译码与执行"><a class="headerlink" href="#译码与执行" title="译码与执行"></a>译码与执行</h3><p>在执行时我们要把一条指令的执行过程分为三步：</p>
<ol>
<li>计算下一个PC值，同时获得要执行的指令。</li>
<li>对指令进行译码，若有必要的话从寄存器堆中选中操作数对应的寄存器</li>
<li>将结果写回寄存器堆</li>
</ol>
<p>那么我们可以做出这样的实现：</p>
<p>首先是构造一个三分频的时钟信号，用于驱动上面三步：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> Clock(</span><br/><span class="line">  <span class="keyword">input</span> <span class="keyword">wire</span> global_clk,</span><br/><span class="line">  <span class="keyword">output</span> <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] generated_clks</span><br/><span class="line">);</span><br/><span class="line">  <span class="keyword">reg</span> [<span class="number">2</span>:<span class="number">0</span>] clk_reg = <span class="number">'b100</span>;</span><br/><span class="line">  <span class="keyword">always</span> @(<span class="keyword">posedge</span> global_clk) <span class="keyword">begin</span></span><br/><span class="line">    {clk_reg[<span class="number">0</span>],clk_reg} = clk_reg &lt;&lt; <span class="number">1</span>;</span><br/><span class="line">  <span class="keyword">end</span></span><br/><span class="line">  <span class="keyword">assign</span> generated_clks = clk_reg;</span><br/><span class="line"><span class="keyword">endmodule</span></span><br/></pre></td></tr></table></figure>
<p>然后是CPU的顶层接口：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br/><span class="line">2</span><br/><span class="line">3</span><br/><span class="line">4</span><br/><span class="line">5</span><br/><span class="line">6</span><br/><span class="line">7</span><br/><span class="line">8</span><br/><span class="line">9</span><br/><span class="line">10</span><br/><span class="line">11</span><br/><span class="line">12</span><br/><span class="line">13</span><br/><span class="line">14</span><br/><span class="line">15</span><br/><span class="line">16</span><br/><span class="line">17</span><br/><span class="line">18</span><br/><span class="line">19</span><br/><span class="line">20</span><br/><span class="line">21</span><br/><span class="line">22</span><br/><span class="line">23</span><br/><span class="line">24</span><br/><span class="line">25</span><br/><span class="line">26</span><br/><span class="line">27</span><br/><span class="line">28</span><br/><span class="line">29</span><br/><span class="line">30</span><br/><span class="line">31</span><br/><span class="line">32</span><br/><span class="line">33</span><br/><span class="line">34</span><br/><span class="line">35</span><br/><span class="line">36</span><br/><span class="line">37</span><br/><span class="line">38</span><br/><span class="line">39</span><br/><span class="line">40</span><br/><span class="line">41</span><br/><span class="line">42</span><br/><span class="line">43</span><br/><span class="line">44</span><br/><span class="line">45</span><br/><span class="line">46</span><br/><span class="line">47</span><br/><span class="line">48</span><br/><span class="line">49</span><br/><span class="line">50</span><br/><span class="line">51</span><br/><span class="line">52</span><br/><span class="line">53</span><br/><span class="line">54</span><br/><span class="line">55</span><br/></pre></td><td class="code"><pre><span class="line"><span class="meta">`<span class="meta-keyword">include</span> "alu.v"</span></span><br/><span class="line"><span class="meta">`<span class="meta-keyword">include</span> "clock.v"</span></span><br/><span class="line"><span class="meta">`<span class="meta-keyword">include</span> "ROM.v"</span></span><br/><span class="line"><span class="meta">`<span class="meta-keyword">include</span> "register_file.v"</span></span><br/><span class="line"><span class="keyword">module</span> CPU(</span><br/><span class="line">    <span class="keyword">input</span> <span class="keyword">wire</span> clk</span><br/><span class="line">);</span><br/><span class="line">    <span class="keyword">wire</span> next_pc_clk;</span><br/><span class="line">    <span class="keyword">wire</span> fetch_data_clk;</span><br/><span class="line">    <span class="keyword">wire</span> write_back_clk;</span><br/><span class="line">    <span class="comment">// 分频时钟</span></span><br/><span class="line">    Clock clock(clk,{write_back_clk,fetch_data_clk,next_pc_clk});</span><br/><span class="line">    <span class="keyword">reg</span> [<span class="number">7</span>:<span class="number">0</span>] program_counter = <span class="number">0</span>;    </span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">15</span>:<span class="number">0</span>] instruction_register;</span><br/><span class="line">    ROM instruction_rom(program_counter,instruction_register);</span><br/><span class="line">    <span class="comment">// 操作数是立即数还是寄存器</span></span><br/><span class="line">    <span class="keyword">wire</span> imm_or_register;</span><br/><span class="line">    <span class="comment">// 是否是跳转</span></span><br/><span class="line">    <span class="keyword">wire</span> jmp;</span><br/><span class="line">    <span class="comment">// ALU操作</span></span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] alu_op;</span><br/><span class="line">     <span class="comment">// 选中输入/输出的寄存器编号</span></span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] out_reg;</span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] in_reg1;</span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">2</span>:<span class="number">0</span>] in_reg2;</span><br/><span class="line">    <span class="comment">// 立即数</span></span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] imm;</span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">1</span>:<span class="number">0</span>] <span class="number">_</span>;</span><br/><span class="line">    <span class="comment">// 译码</span></span><br/><span class="line">    <span class="keyword">assign</span> {imm_or_register,jmp,alu_op,out_reg,in_reg2,in_reg1,<span class="number">_</span>} = instruction_register;</span><br/><span class="line">    <span class="keyword">assign</span> imm = instruction_register[<span class="number">7</span>:<span class="number">0</span>];</span><br/><span class="line">    <span class="comment">// 寄存器堆的输出</span></span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] out_1;</span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] out_2;</span><br/><span class="line">    <span class="comment">// 寄存器堆的输入</span></span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] in;</span><br/><span class="line">       <span class="comment">// 寄存器堆是否接受输入</span></span><br/><span class="line">    <span class="keyword">wire</span> in_en;</span><br/><span class="line">    </span><br/><span class="line">    <span class="keyword">wire</span> [<span class="number">7</span>:<span class="number">0</span>] op1;</span><br/><span class="line">    <span class="keyword">always</span> @(<span class="keyword">posedge</span> next_pc_clk) <span class="keyword">begin</span></span><br/><span class="line">        <span class="comment">// PC+1</span></span><br/><span class="line">        program_counter &lt;= program_counter + <span class="number">1</span>;</span><br/><span class="line">        <span class="keyword">if</span> (jmp) <span class="keyword">begin</span></span><br/><span class="line">            <span class="comment">// 跳转</span></span><br/><span class="line">            program_counter &lt;= imm;</span><br/><span class="line">        <span class="keyword">end</span></span><br/><span class="line">    <span class="keyword">end</span></span><br/><span class="line">    <span class="comment">// 跳转时，寄存器堆不接受输入</span></span><br/><span class="line">    <span class="keyword">assign</span> in_en = jmp?<span class="number">0</span>:<span class="number">1</span>;</span><br/><span class="line">    RegisterFile register_file(fetch_data_clk,write_back_clk,in_reg1,in_reg2,out_1,out_2,out_reg,in,in_en);</span><br/><span class="line">    <span class="comment">// 第一个操作数根据译码得到的 操作数是立即数还是寄存器 的值，选择使用立即数还是寄存器堆输出1</span></span><br/><span class="line">    <span class="keyword">assign</span> op1 = imm_or_register ? imm : out_1;</span><br/><span class="line">    ALU alu(op1,out_2,alu_op,in);</span><br/><span class="line"><span class="keyword">endmodule</span></span><br/></pre></td></tr></table></figure>
<p>这样一来这个CPU就能跑了。</p>
<h2 id="Futher-work"><a class="headerlink" href="#Futher-work" title="Futher work"></a>Futher work</h2><ol>
<li>和内存对接</li>
<li>流水线</li>
</ol>
<blockquote id="fn_1">
<sup>1</sup>. 因此甚至不需要一个IR寄存器。<a href="#reffn_1" title="Jump back to footnote [1] in the text."> ↩</a>
</blockquote>

</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-01-29</span><i class="fa fa-tag"></i><a class="tag" href="/tags/verilog/" title="verilog">verilog </a><a class="tag" href="/tags/计算机组成/" title="计算机组成">计算机组成 </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://longfangsong.github.io/2019/01/29/简单CPU的设计与实现/,Blog,简单CPU的设计与实现,;" target="_blank" rel="noopener"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/03/11/%E5%AF%BB%E5%9D%80%E6%96%B9%E5%BC%8F/" title="寻址方式">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2018/12/25/Mocha%20with%20typescript%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/" title="Mocha with typescript环境配置">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@v1.1.7/dist/Valine.min.js?v=undefined"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false, 
  verify:false|| false, 
  app_id:'HcCTt2sXmRChcaE4nMoSibwJ-gzGzoHsz',
  app_key:'6eevqWRr7jsWPUavkkAQjIMi',
  placeholder:'随便说点啥吧……',
  path: window.location.pathname,
  avatar:'mm'
})</script><script src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-MML-AM_CHTML"></script><script>MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [['$','$'], ["\\(","\\)"]],
    displayMath: [['$$','$$'], ["\\[","\\]"]]
  }
});</script></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>