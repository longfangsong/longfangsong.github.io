<!DOCTYPE html>
<html lang="en">
<head>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, viewport-fit=cover">
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://longfangsong.github.io/images/apple-touch-icon-144x144.png"/>
  <link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://longfangsong.github.io/images/apple-touch-icon-120x120.png"/>
  <link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://longfangsong.github.io/images/apple-touch-icon-72x72.png"/>
  <link rel="apple-touch-icon-precomposed" sizes="57x57" href="https://longfangsong.github.io/images/apple-touch-icon-57x57.png"/>
  <link rel="short icon" href="https://longfangsong.github.io/images/favicon.png" type="image/x-icon"/>
  <link rel="stylesheet" href="https://longfangsong.github.io/style.css">
  <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
  <title>Blog â€¢ Hack RISC-V æŒ‡ä»¤é›†</title>
  
  
<link rel="stylesheet" href="https://longfangsong.github.io/blog.css">
<script src="//cdn.wordart.com/wordart.min.js" async defer></script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YG5Z4J086Y"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YG5Z4J086Y');
</script>

</head>
<body>
<div id="sidebar" class="animated fadeInDown">
  <div class="logo-title">
    <div class="title">
      <img src=https://longfangsong.github.io/images/logo@2x.png style="width:127px;" alt="logo"/>
      <h3><a href="https://longfangsong.github.io/">Blog</a></h3>
      <div class="description">
        <p>ç”Ÿå‘½æ˜¯ç°è‰²çš„ï¼Œè€Œç†è®ºä¹‹æ ‘å¸¸é’</p>
      </div>
    </div>
  </div>
  <ul class="social-links"><li><a href="https://github.com/longfangsong"><i class="fab fa-github"></i></a></li><li><a href="https://twitter.com/longfangsong"><i class="fab fa-twitter"></i></a></li><li><a href="https://www.facebook.com/longfangsong"><i class="fab fa-facebook"></i></a></li>
<div id="pirate" data-wordart-src="//cdn.wordart.com/json/685czi4rqil5" style="width: 100%;"
    data-wordart-show-attribution></div>

  </ul>
  <div class="footer">
    
    <span>Designed by </span><a href="https://www.caicai.me">CaiCai</a>
    <div class="by_zola"><a href="https://www.getzola.org/" target="_blank">Proudly published with Zola!</a></div>
    
  </div>
</div>
<div id="main">
  <div class="page-top animated fadeInDown">
    <div class="nav">
      <li><a  href="https://longfangsong.github.io/">é¦–é¡µ</a></li><li><a  href="https://longfangsong.github.io/about/">å…³äº</a></li><li><a  href="https://longfangsong.github.io/tags">æ ‡ç­¾</a></li><li><a  href="https://longfangsong.github.io/archive/">å½’æ¡£</a></li><li><a  href="https://longfangsong.github.io/links/">å‹é“¾</a></li></div>
    <div class="information">
      <div class="back_btn">
        <li><a onclick="window.history.go(-1)" ><i class="fas fa-chevron-left"></i></a></li>
      </div>
      <div class="avatar"><img src="https://longfangsong.github.io/images/avatar.jpg"></div>
    </div>
  </div>
  <div class="autopagerize_page_element">
    <div class="content">
    
<article class="post animated fadeInDown">
  <h1><a href="https:&#x2F;&#x2F;longfangsong.github.io&#x2F;hack-riscv-isa&#x2F;">Hack RISC-V æŒ‡ä»¤é›†</a></h1>
  
  <div class="post-content"><h2 id="huan-jing">ç¯å¢ƒ</h2>
<p>æœ¬æ–‡å‡è®¾ç”¨æˆ·ä½¿ç”¨åŸºäº debian çš„ Linux ç³»ç»Ÿï¼Œæœ‰ <code>su</code> æˆ–è€… <code>sudo</code> çš„èƒ½åŠ›<sup class="footnote-reference"><a href="#1">1</a></sup>ï¼Œå¹¶ä¸”ç”¨çš„æ–‡ä»¶ç³»ç»Ÿæ˜¯åŒºåˆ†å¤§å°å†™<sup class="footnote-reference"><a href="#2">2</a></sup>çš„ã€‚</p>
<p>ç„¶åè¯·äº‹å…ˆå®‰è£… <code>git</code> ä»¥åŠä»»æ„æ–‡æœ¬ç¼–è¾‘å™¨ã€‚</p>
<h2 id="gnu-bian-yi-gong-ju-lian">GNU ç¼–è¯‘å·¥å…·é“¾</h2>
<h3 id="clone-dai-ma">clone ä»£ç </h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">git</span><span> clone https://github.com/riscv/riscv-gnu-toolchain
</span></code></pre>
<p>ç„¶åè¿›å…¥ clone åˆ°çš„æ–‡ä»¶å¤¹ä¸­ã€‚</p>
<h3 id="zhuang-yi-lai">è£…ä¾èµ–</h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">apt-get</span><span> install autoconf automake autotools-dev curl python3 libmpc-dev libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev
</span></code></pre>
<h3 id="zhun-bei-yao-an-zhuang-dao-de-wei-zhi">å‡†å¤‡è¦å®‰è£…åˆ°çš„ä½ç½®</h3>
<p>æ¯”å¦‚è¦æŠŠå·¥å…·é“¾è£…åˆ° <code>/opt/riscv</code> ä¸‹çš„è¯ï¼š</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">mkdir</span><span> /opt/riscv
</span><span style="color:#bf616a;">chmod</span><span> 777 /opt/riscv </span><span style="color:#65737e;"># just use 777, who cares about bad guys?
</span></code></pre>
<h3 id="configure"><code>configure</code></h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">./configure --prefix</span><span>=/opt/riscv</span><span style="color:#bf616a;"> --enable-multilib
</span></code></pre>
<h3 id="make"><code>make</code></h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">make
</span></code></pre>
<p>One eternity later ...</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">make</span><span> linux
</span></code></pre>
<p>Two eternities later ...</p>
<p>æ³¨æ„æ¯æ¬¡ <code>make</code> çš„æ—¶å€™éƒ½ä¼šä¸‹è½½å¯¹åº”çš„ <code>submodule</code>ï¼Œè¯·ä¿è¯æœ‰æ­£å¸¸çš„ç½‘ç»œç¯å¢ƒã€‚</p>
<p>ç„¶å <code>/opt/riscv</code> é‡Œå°±æœ‰ç¼–è¯‘å™¨ã€lib ç­‰ç­‰äº†ã€‚</p>
<h3 id="tian-jia-zi-ding-yi-zhi-ling">æ·»åŠ è‡ªå®šä¹‰æŒ‡ä»¤</h3>
<p>ç¼–è¾‘ <code>riscv-binutils/opcodes/riscv-opc.c</code>ï¼Œåœ¨ <code>riscv_opcodes</code> ä¸­åŠ å…¥æ–°çš„æŒ‡ä»¤:</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span>{
</span><span>    &quot;</span><span style="color:#a3be8c;">&lt;æŒ‡ä»¤åç§°&gt;</span><span>&quot;, </span><span style="color:#d08770;">0</span><span>, &lt;æŒ‡ä»¤ç±»å‹&gt;, &quot;</span><span style="color:#a3be8c;">&lt;æ“ä½œæ•°&gt;</span><span>&quot;, 
</span><span>    &lt;åŒ¹é…&gt;, &lt;æ©ç &gt;, match_opcode, </span><span style="color:#d08770;">0
</span><span>},
</span></code></pre>
<p>ä»£è¡¨ä½¿ç”¨æ—¶å½¢å¦‚ï¼š</p>
<pre data-lang="asm" style="background-color:#2b303b;color:#c0c5ce;" class="language-asm "><code class="language-asm" data-lang="asm"><span style="color:#8fa1b3;">&lt;æŒ‡ä»¤åç§°&gt; &lt;æ“ä½œæ•°&gt;
</span></code></pre>
<p>çš„ä¸€æ¡æ±‡ç¼–æŒ‡ä»¤ã€‚</p>
<h4 id="zhi-ling-lei-xing">æŒ‡ä»¤ç±»å‹</h4>
<p>å»ºè®®æ— è„‘ç»™ <code>INSN_CLASS_I</code>, å› ä¸º <code>I</code> åœ¨æ‰€æœ‰æƒ…å†µä¸‹éƒ½æ˜¯æ”¯æŒçš„ï¼Œæ— éœ€åœ¨ç¼–è¯‘æ—¶æ‰‹åŠ¨å¼€å¯å„ä¸ªæŒ‡ä»¤é›†ã€‚</p>
<p>æš‚æ—¶ä¸æ¸…æ¥šæ˜¯å¦æ”¯æŒåœ¨ <code>include/opcode/riscv.h</code> ä¸­çš„ <code>riscv_insn_class</code> ä¸­æ·»åŠ è‡ªå·±çš„æŒ‡ä»¤é›†åç§°ï¼Œç„¶ååœ¨è¿™é‡Œä½¿ç”¨ã€‚</p>
<h4 id="cao-zuo-shu">æ“ä½œæ•°</h4>
<p>è¿™æˆ‘ä¸€ç›´æ²¡æ‰¾åˆ°ä¸€ä¸ªè¯´æ˜çš„æ–‡æ¡£ï¼Œåªæœ‰æ ¹æ®å·²ç»å†™å¥½çš„éƒ¨åˆ†å’Œä»£ç ï¼ˆä»£ç åœ¨ <code>riscv-binutils/gas/config/tc-riscv.c</code>ï¼‰æ¨äº†<sup class="footnote-reference"><a href="#3">3</a></sup>ï¼š</p>
<ul>
<li>
<p><code>d</code>
ä»£è¡¨ç›®æ ‡å¯„å­˜å™¨</p>
</li>
<li>
<p><code>s</code>
ä»£è¡¨ç¬¬ä¸€ä¸ªå¯„å­˜å™¨æ“ä½œæ•°</p>
</li>
<li>
<p><code>t</code>
ä»£è¡¨ç¬¬äºŒä¸ªå¯„å­˜å™¨æ“ä½œæ•°</p>
</li>
<li>
<p><code>j</code>
ä»£è¡¨ä¸€ä¸ªç«‹å³æ•°</p>
</li>
<li>
<p><code>o(s)</code>
ä»£è¡¨ç”¨äºè¯»å–å‡ºæ¥çš„ä¸€ä¸ªåœ°å€ï¼Œæ ¼å¼ä¸ºå¯„å­˜å™¨ + åç§»é‡</p>
</li>
<li>
<p><code>q(s)</code>
ä»£è¡¨ç”¨äºå†™å…¥è¿›å»çš„ä¸€ä¸ªåœ°å€ï¼Œæ ¼å¼ä¸ºå¯„å­˜å™¨ + åç§»é‡</p>
</li>
<li>
<p><code>&lt;</code> å’Œ <code>&gt;</code>
ä»£è¡¨ç§»ä½çš„ä½æ•°</p>
</li>
</ul>
<h5 id="ke-zhi-ji-cun-qi">å®¢åˆ¶å¯„å­˜å™¨</h5>
<p>è¿™é‡Œå‡è®¾ä½ å¸Œæœ›åœ¨å†…è”æ±‡ç¼–é‡Œæ‰‹å†™å¯„å­˜å™¨è€Œä¸æ˜¯è®© gcc ä¸ºä½ åˆ†é…ä½ çš„å®¢åˆ¶å¯„å­˜å™¨ï¼Œæ¯”å¦‚ä½ å¸Œæœ›æ·»åŠ ä¸€ä¸ªè¯»å–çŸ©é˜µçš„æŒ‡ä»¤ï¼š</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span>{&quot;</span><span style="color:#a3be8c;">matload</span><span>&quot;, </span><span style="color:#d08770;">0</span><span>, INSN_CLASS_I, &quot;</span><span style="color:#a3be8c;">Md,o(s)</span><span>&quot;, </span><span style="color:#d08770;">0x100b</span><span>, </span><span style="color:#d08770;">0x707f</span><span>, match_opcode, INSN_DREF},
</span></code></pre>
<p>è¿™é‡Œçš„ <code>Md</code> ä»£è¡¨ä¸€ä¸ªçŸ©é˜µå¯„å­˜å™¨ã€‚</p>
<p>é‚£ä¹ˆä½ éœ€è¦åœ¨ gnu å·¥å…·é“¾ä¸­è¿›è¡Œå¦‚ä¸‹ä¿®æ”¹ï¼š</p>
<ol>
<li>
<p>åœ¨ <code>riscv-binutils/opcodes/riscv-opc.c</code> ä¸­çš„ <code>riscv_fpr_names_abi</code> ä¸‹é¢ï¼Œæ·»åŠ ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œä¿å­˜ä½ çš„å„ä¸ªå¯„å­˜å™¨çš„åå­—ï¼Œå¹¶åœ¨ <code>riscv-binutils/include/opcode/riscv.h</code> æ·»åŠ ç›¸åº”çš„å£°æ˜ï¼Œä¾‹å¦‚ï¼š</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#65737e;">// riscv.h
</span><span style="color:#b48ead;">extern const char </span><span>*</span><span style="color:#b48ead;">const</span><span> riscv_mat_names_numeric[</span><span style="color:#d08770;">8</span><span>];
</span></code></pre>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#65737e;">// riscv-opc.c
</span><span style="color:#b48ead;">const char </span><span>* </span><span style="color:#b48ead;">const</span><span> riscv_mat_names_numeric[</span><span style="color:#d08770;">8</span><span>] ={&quot;</span><span style="color:#a3be8c;">mat0</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">mat1</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">mat2</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">mat3</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">mat4</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">mat5</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">mat6</span><span>&quot;, &quot;</span><span style="color:#a3be8c;">mat7</span><span>&quot;};
</span></code></pre>
</li>
<li>
<p>åœ¨ <code>reg_class</code> ï¼ˆåœ¨ <code>riscv-binutils/gas/config/tc-riscv.c</code>ï¼‰ä¸­æ·»åŠ è¿™ä¸ªå®¢åˆ¶å¯„å­˜å™¨é›†çš„â€œåç§°â€ï¼š</p>
<pre data-lang="diff" style="background-color:#2b303b;color:#c0c5ce;" class="language-diff "><code class="language-diff" data-lang="diff"><span>enum reg_class
</span><span>{
</span><span>  RCLASS_GPR,
</span><span>  RCLASS_FPR,
</span><span style="color:#a3be8c;">+ RCLASS_MPR,
</span><span>  RCLASS_MAX,
</span><span>  RCLASS_CSR
</span><span>};
</span></code></pre>
</li>
<li>
<p>åœ¨åŒä¸€æ–‡ä»¶ä¸‹è´Ÿè´£æ±‡ç¼–å™¨åˆå§‹åŒ–çš„ <code>md_begin</code> å‡½æ•°ä¸­æ³¨å†Œè¿™ä¸ªå®¢åˆ¶å¯„å­˜å™¨é›†ï¼š</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#bf616a;">hash_reg_names</span><span>(RCLASS_MPR, riscv_mat_names_numeric, </span><span style="color:#d08770;">8</span><span>);
</span></code></pre>
</li>
<li>
<p>åœ¨åŒä¸€æ–‡ä»¶ä¸‹æ£€æŸ¥ RISC-V æŒ‡ä»¤æ ¼å¼çš„ <code>validate_riscv_insn</code> å‡½æ•°ä¸­ä¸ªçš„æœ€å¤§çš„é‚£ä¸ª <code>switch</code> ä¸­æ·»åŠ å¯¹è¿™ä¸ªå¯„å­˜å™¨å‚æ•°çš„æ£€æŸ¥ã€‚</p>
</li>
<li>
<p>åœ¨åŒä¸€æ–‡ä»¶ä¸‹è´Ÿè´£è¿›è¡Œå®é™…æ±‡ç¼–åˆ°äºŒè¿›åˆ¶ä»£ç çš„ <code>riscv_ip</code> å‡½æ•°ä¸­æ·»åŠ ç”ŸæˆäºŒè¿›åˆ¶ä»£ç çš„ä»£ç ã€‚</p>
</li>
</ol>
<p>åˆ°æ­¤ä½ çš„ç¼–è¯‘å™¨å·²ç»èƒ½æ­£å¸¸ç”ŸæˆäºŒè¿›åˆ¶ä»£ç äº†ï¼Œä½†æ˜¯å¦‚æœä½ è¿˜æƒ³è¦ç”¨ <code>objdump</code> ä¹‹ç±»çš„åç¼–è¯‘å·¥å…·ï¼š</p>
<ol start="6">
<li>åœ¨ <code>riscv-binutils/opcodes/riscv-dis.c</code> ä¸­çš„ <code>print_insn_args</code> ä¸­ä¹Ÿæ·»åŠ ç›¸å…³è§£æä»£ç ã€‚</li>
</ol>
<h4 id="pi-pei-he-yan-ma">åŒ¹é…å’Œæ©ç </h4>
<p>è®¾æœ‰ä¸€æ¡äºŒè¿›åˆ¶æŒ‡ä»¤ <code>instruction</code>, è‹¥ï¼š</p>
<pre data-lang="c" style="background-color:#2b303b;color:#c0c5ce;" class="language-c "><code class="language-c" data-lang="c"><span>instruction &amp; æ©ç  == åŒ¹é…
</span></code></pre>
<p>åˆ™è®¤ä¸º <code>instruction</code> æ˜¯è¿™ä¸€ç±»çš„æŒ‡ä»¤ã€‚</p>
<h4 id="zhong-xin-bian-yi">é‡æ–°ç¼–è¯‘</h4>
<p>é‡æ–°ç¼–è¯‘å·¥å…·é“¾éœ€è¦ <code>make clean</code>ï¼Œåˆ ç©ºå®‰è£…ä½ç½®ï¼ˆå¦‚ <code>/opt/riscv</code>ï¼‰ï¼Œç„¶åé‡æ–° <code>make</code><sup class="footnote-reference"><a href="#4">4</a></sup>ã€‚</p>
<h3 id="shi-yong">ä½¿ç”¨</h3>
<p>ç„¶åå°±èƒ½åœ¨æ±‡ç¼–é‡Œæ‹¿ <code>asm</code> ç”¨ä½ åˆšåˆšåŠ çš„æŒ‡ä»¤äº†ã€‚</p>
<p>å¦‚æœä½ ä¸æ˜¯å¾ˆæ‡‚å†…è”æ±‡ç¼–<sup class="footnote-reference"><a href="#5">5</a></sup>ï¼Œå¯ä»¥çœ‹çœ‹æˆ‘çš„<a href="https://longfangsong.github.io/inline-asm-cheatsheet/">å¦ä¸€ç¯‡æ–‡ç« </a>ã€‚</p>
<h2 id="risc-v-tools">RISC-V tools</h2>
<p>æˆ‘ä»¬ä¸»è¦ä½¿ç”¨ RISC-V tools ä¸­çš„ RISC-V è¡Œä¸ºçº§æ¨¡æ‹Ÿå™¨ â€”â€” spikeã€‚</p>
<h3 id="clone-dai-ma-1">clone ä»£ç </h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">git</span><span> clone https://github.com/riscv/riscv-tools.git
</span></code></pre>
<p>ç„¶åè¿›å…¥ clone åˆ°çš„æ–‡ä»¶å¤¹ä¸­ã€‚</p>
<p>ä¸ GNU å·¥å…·é“¾åœ¨ <code>make</code> çš„æ—¶å€™ä¼šè‡ªåŠ¨æ‹¿ submodule ä¸åŒï¼Œtools è¿™è¾¹è¦æ‰‹åŠ¨ï¼š</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">git</span><span> submodule update</span><span style="color:#bf616a;"> --init --recursive
</span></code></pre>
<p>æ­¤å¤–å»ºè®®æŠŠæˆ‘ä»¬é‡ç‚¹è¦ä¿®æ”¹çš„ <code>riscv-isa-sim</code> æ‰‹åŠ¨æ›´æ–°åˆ° origin master ç‰ˆæœ¬ï¼š</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#96b5b4;">cd</span><span> riscv-isa-sim
</span><span style="color:#bf616a;">git</span><span> pull origin master
</span></code></pre>
<h3 id="zhi-ding-an-zhuang-di-zhi">æŒ‡å®šå®‰è£…åœ°å€</h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#b48ead;">export </span><span style="color:#bf616a;">RISCV</span><span>=&lt;å®‰è£…åœ°å€&gt;
</span></code></pre>
<h3 id="build">build</h3>
<p>å¦‚æœä½ æŒ‰ç…§å®˜æ–¹è¯´æ˜ç›´æ¥åœ¨ clone åˆ°çš„æ–‡ä»¶å¤¹ä¸­ï¼š</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">./build.sh
</span></code></pre>
<p>é‚£ä½ å¤§æ¦‚ç‡ä¼šç¢°åˆ° riscv-test submodule é‡Œçš„å…³äº <code>tohost</code> å’Œ <code>fromhost</code> é‡å¤å®šä¹‰çš„é”™è¯¯ï¼Œå¯ä»¥é‡‡ç”¨<a href="https://github.com/riscv/riscv-tests/issues/286#issuecomment-801002149">è¿™é‡Œæåˆ°</a>çš„æ–¹æ³•ä¿®å¤<sup class="footnote-reference"><a href="#6">6</a></sup>ï¼š</p>
<p>ä¿®æ”¹ <code>./riscv-tests/isa/Makefile</code> ä¸­çš„ç¼–è¯‘é€‰é¡¹ï¼š</p>
<pre data-lang="diff" style="background-color:#2b303b;color:#c0c5ce;" class="language-diff "><code class="language-diff" data-lang="diff"><span style="color:#bf616a;">-RISCV_GCC_OPTS ?= -static -mcmodel=medany -fvisibility=hidden -nostdlib -nostartfiles
</span><span style="color:#a3be8c;">+RISCV_GCC_OPTS ?= -static -mcmodel=medany -fvisibility=hidden -nostdlib -nostartfiles -fcommon
</span></code></pre>
<h3 id="tian-jia-zi-ding-yi-zhi-ling-ji">æ·»åŠ è‡ªå®šä¹‰æŒ‡ä»¤é›†</h3>
<p>åœ¨ Spike æ¨¡æ‹Ÿå™¨ä¸­æ·»åŠ å®¢åˆ¶æŒ‡ä»¤é›†éå¸¸æ–¹ä¾¿ï¼Œåªéœ€è¦åœ¨ <code>./riscv-isa-sim/customext/</code> ä¸­æ·»åŠ ä¸€ä¸ªå®ç°æ‰©å±•æŒ‡ä»¤é›†è¡Œä¸ºçš„æ–‡ä»¶ï¼Œ
å…¶ä¸­æœ‰ä¸€ä¸ªç±»å®ç°äº† <code>extension_t</code>ï¼Œç„¶åç”¨ <code>REGISTER_EXTENSION</code> å®å°†å…¶æ³¨å†Œåˆ°æ¨¡æ‹Ÿå™¨å³å¯ã€‚</p>
<p><code>extension_t</code> è¦æ±‚ä¸€ä¸ª <code>name</code>ï¼Œä¸€ä¸ªæ‹¿æ‰€æœ‰æŒ‡ä»¤çš„ <code>get_instructions</code>ï¼Œä¸€ä¸ªæ‹¿æ‰€æœ‰åæ±‡ç¼–æŒ‡ä»¤çš„ <code>get_disasms</code>ã€‚</p>
<h2 id="gem5-mo-ni-qi">gem5 æ¨¡æ‹Ÿå™¨</h2>
<h3 id="clone-dai-ma-2">clone ä»£ç </h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">git</span><span> clone https://gem5.googlesource.com/public/gem5
</span></code></pre>
<h3 id="zhuang-yi-lai-1">è£…ä¾èµ–</h3>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">sudo</span><span> apt install build-essential git m4 scons zlib1g zlib1g-dev \
</span><span>    libprotobuf-dev protobuf-compiler libprotoc-dev libgoogle-perftools-dev \
</span><span>    python3-dev python3-six python libboost-all-dev pkg-config
</span></code></pre>
<h3 id="build-1">build</h3>
<p>åœ¨ clone åˆ°çš„æ–‡ä»¶å¤¹ä¸­ï¼š</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">/usr/bin/env</span><span> python3 $(</span><span style="color:#bf616a;">which</span><span> scons) build/RISCV/gem5.opt</span><span style="color:#bf616a;"> -j </span><span>&lt;CPUæ ¸æ•°&gt;
</span></code></pre>
<p>å¦‚æœä½ æƒ³è¦åœ¨ä½ çš„ç¨‹åºä¸­åŠ  <code>checkpoint</code>ã€é‡ç½®ç»Ÿè®¡æ•°æ®ç­‰ï¼Œéœ€è¦æ„å»º <code>libm5</code>ï¼š</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">/usr/bin/env</span><span> python3 $(</span><span style="color:#bf616a;">which</span><span> scons)</span><span style="color:#bf616a;"> -C</span><span> util/m5 build/riscv/out/m5
</span></code></pre>
<h3 id="shi-yong-1">ä½¿ç”¨</h3>
<p>å¦‚æœä½ ç¼–å†™çš„ç¨‹åºä¸­ä½¿ç”¨äº† <code>libm5</code> ä¸­çš„åŠŸèƒ½ï¼Œéœ€è¦åŒ…å« <code>gem5/m5ops.h</code> å¹¶åœ¨é“¾æ¥æ—¶é“¾æ¥ <code>libm5.a</code>ï¼š</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">riscv64-linux-gnu-gcc -static -I</span><span>/home/longfangsong/workspace/gem5/include/</span><span style="color:#bf616a;"> -I </span><span>&lt;gem5 ä½ç½®&gt;/gem5/include/</span><span style="color:#bf616a;"> -static </span><span>&lt;å…¶ä»–æºæ–‡ä»¶&gt; &lt;gem5 ä½ç½®&gt;/gem5/util/m5/build/riscv/out/libm5.a
</span></code></pre>
<h4 id="trick-on-profiling-unspported-isa-set">Trick on profiling unspported ISA set</h4>
<p><code>gem5</code> åªæ”¯æŒä½¿ç”¨ <code>riscv64-linux-gnu-gcc</code> ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œä¸”å‡å®šäº†ç”¨æˆ·æœ‰ç¡¬æµ®ç‚¹æ”¯æŒï¼Œè¿™åœ¨æƒ³è¦æ¯”è¾ƒä¸åŒæŒ‡ä»¤é›†æ—¶ä¼šå¸¦æ¥ä¸€äº›ä¸ä¾¿ã€‚</p>
<p>è§£å†³æ–¹æ¡ˆéå¸¸å‘†ä½†å¾ˆæœ‰æ•ˆï¼Œå°±æ˜¯å…ˆç”¨ <code>riscv64-unknown-elf-gcc</code> æ‹¿åˆ°æŸä¸ªæŒ‡ä»¤é›†å’Œ abiï¼ˆå¦‚æœè¦ç”¨å’Œæœ€ç»ˆç¼–è¯‘åˆ°äºŒè¿›åˆ¶æ–‡ä»¶æ—¶ä¸åŒçš„ abi çš„è¯å»ºè®®é€šè¿‡å…¨å±€å˜é‡ä¼ å‚æ•°å’Œè¿”å›å€¼ï¼‰ ä¸‹çš„æ±‡ç¼–ï¼Œç„¶åç”¨ <code>riscv64-linux-gnu-gcc</code> ç¼–è¯‘æ±‡ç¼–æ¥ç”Ÿæˆæœ€ç»ˆçš„äºŒè¿›åˆ¶æ–‡ä»¶ä»¥ä¾› <code>gem5</code> æ‰§è¡Œã€‚</p>
<p>å¯èƒ½ä¼šç”¨åˆ°è½¯ä¹˜æ³•ã€è½¯æµ®ç‚¹ç­‰ç­‰çš„libgcc ä¸­çš„ polyfill ä»£ç ï¼ŒæŠŠè¿™äº›ä¹Ÿæ‹‰è¿‡æ¥ç¼–è¯‘å°±æ˜¯äº†<sup class="footnote-reference"><a href="#7">7</a></sup>, ç›®å‰å·²çŸ¥çš„å‡ ä»½ polyfill ä»£ç çš„ä½ç½®éƒ½ä½äº <code>riscv-gnu-toolchain/libgcc</code> ä¸‹ï¼Œ<code>softfp</code> å°±æ˜¯è½¯æµ®ç‚¹ï¼Œ<code>config/riscv</code> å°±æ˜¯å…¶ä»–ä¸€äº›ä¸œè¥¿çš„ polyfillï¼Œæ¯”å¦‚ä¹˜é™¤æ³•ï¼ŒåŸå­æ“ä½œç­‰ç­‰ã€‚</p>
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>å› ä¸º debian å¯ä»¥åœ¨ <code>su</code> ä¸‹é¢åšæ‰€æœ‰çš„äº‹ï¼Œ<code>sudo</code> åè€Œè¦è‡ªå·±è£…ï¼Œdocker ä¸€æ‰“å¼€å°±æ˜¯ <code>su</code>ï¼Œä¸ºäº†å¤åˆ¶ç²˜è´´æ–¹ä¾¿ä¸‹é¢éƒ½ä¸ä¼šå†™æ˜è¦ <code>sudo</code> çš„åœ°æ–¹ï¼Œå¦‚æœæœ‰å¿…è¦çš„è¯è‡ªå·±åŠ â€¦â€¦</p>
</div>
<div class="footnote-definition" id="2"><sup class="footnote-definition-label">2</sup>
<p>è¿™æ˜¯çœŸçš„å‘ã€‚è¿˜å¥½æ­£å¸¸çš„ Linux ç³»ç»Ÿå®‰è£…å™¨é»˜è®¤çš„æ–‡ä»¶ç³»ç»Ÿéƒ½æ˜¯åŒºåˆ†å¤§å°å†™çš„ã€‚ä½†ç”¨ Docker æŒ‚å…¶ä»–ç³»ç»Ÿçš„ Volume å°±ä¸ä¸€å®šäº†â€¦â€¦</p>
</div>
<div class="footnote-definition" id="3"><sup class="footnote-definition-label">3</sup>
<p>æ²¡æ–‡æ¡£å°± nm ç¦»è°±ï¼Œæœ‰äº›å­—æ¯ç”¨çš„ä¹ŸæŒºç¦»è°±ã€‚</p>
</div>
<div class="footnote-definition" id="4"><sup class="footnote-definition-label">4</sup>
<p>è¿™ç¾¤å¼€å‘è€…å†™çš„ä»€ä¹ˆé¬¼ Makefile å•¦ã€‚</p>
</div>
<div class="footnote-definition" id="5"><sup class="footnote-definition-label">5</sup>
<p>è®²é“ç†æˆ‘ä¹Ÿä¸æ‡‚ ğŸ˜­</p>
</div>
<div class="footnote-definition" id="6"><sup class="footnote-definition-label">6</sup>
<p>å®˜æ–¹ç»´æŠ¤åœ¨å¹²ä»€ä¹ˆä¸œè¥¿å•Š.jpg</p>
</div>
<div class="footnote-definition" id="7"><sup class="footnote-definition-label">7</sup>
<p>ç°åœ¨æˆ‘æ‡‚ä¸ºå•¥ C++ å¤§å‹é¡¹ç›®ä¸ºå•¥è¦æŠŠä¾èµ–ä¹Ÿæåˆ°é¡¹ç›®çš„ <code>./third_parties</code> é‡Œé¢ä¸€èµ·ç¼–è¯‘äº†ï¼Œå¦åˆ™è¿™ä¸ªé“¾æ¥ã€ abi ä»€ä¹ˆçš„æ˜¯çœŸçš„éº»çƒ¦ã€‚</p>
</div>
</div>
  <div class="post-footer">
    <div class="meta">
      <div class="info">
        
          <i class="far fa-sun"></i><span class="date">2021å¹´04æœˆ17æ—¥</span>
        
        
          <i class="fas fa-tags"></i>
          
            <a class="tag" href="https://longfangsong.github.io/tags/RISC-V">&nbsp;RISC-V</a>
          
            <a class="tag" href="https://longfangsong.github.io/tags/ä½“ç³»ç»“æ„">&nbsp;ä½“ç³»ç»“æ„</a>
          
        
      </div>
    </div>
  </div>
</article>
<div class="share">
  <div class="weibo">
    <a class="fab fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&title=',e(d.title),'&appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a>
  </div>
  <div class="twitter">
    <a class="fab fa-twitter" href="http://twitter.com/share?text=Hack RISC-V æŒ‡ä»¤é›†&url=https:&#x2F;&#x2F;longfangsong.github.io&#x2F;hack-riscv-isa&hashtags=RISC-V,ä½“ç³»ç»“æ„"></a>
  </div>
</div>



    <a id="comments"></a>
    <div id="vcomments" style="margin: 30px;"></div>
    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
    <script>
      var valine = new Valine({
        el: "#vcomments",
        notify: "false" || false,
        verify: "false" || false,
        app_id: "HcCTt2sXmRChcaE4nMoSibwJ-gzGzoHsz",
        app_key: "6eevqWRr7jsWPUavkkAQjIMi",
        placeholder: "éšä¾¿è¯´ç‚¹å•¥å§â€¦â€¦",
        path: window.location.pathname,
        avatar: "mm"
      });
    </script>







    </div>
  </div>
</div>
</body>
</html>
