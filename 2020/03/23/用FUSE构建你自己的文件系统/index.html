<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="龙方淞,longfangsong@icloud.com"><meta name="apple-mobile-web-app-capable" content="yes"><title>用FUSE构建你自己的文件系统 · Blog</title><meta name="description" content="用户空间文件系统（Filesystem in Userspace，简称FUSE）是一个面向类Unix计算机操作系统的软件接口，它使无特权的用户能够无需编辑内核代码而创建自己的文件系统。当前Linux通过内核模块对此进行支持。一些文件系统如ZFS、glusterfs和lustre使用FUSE实现。——"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="icon" sizes="any" href="/images/favicon.png" type="image/x-icon"><link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144.png"><link rel="apple-touch-icon-precomposed" sizes="120x120" href="/images/apple-touch-icon-120x120.png"><link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72.png"><link rel="apple-touch-icon-precomposed" sizes="57x57" href="/images/apple-touch-icon-57x57.png"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/css/SourceCodeVariable-font.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Blog</a></h3><div class="description"><p>生命是灰色的，而理论之树常青</p></div></div></div><div style="width: 100%;" id="pirate" data-wordart-src="//cdn.wordart.com/json/685czi4rqil5" data-wordart-show-attribution></div><script src="//cdn.wordart.com/wordart.min.js" async defer></script><ul class="social-links"><li><a href="http://github.com/longfangsong"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by</span></a><a href="https://www.caicai.me"> CaiCai</a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div><span class="opacity" id="busuanzi_container_site_pv">访问量</span><span class="opacity" id="busuanzi_value_site_uv"></span><span class="opacity">人次</span><script src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/tags">标签</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>用FUSE构建你自己的文件系统</a></h3></div><div class="post-content"><blockquote>
<p><strong>用户空间文件系统</strong>（<strong>F</strong>ilesystem in <strong>Use</strong>rspace，简称<strong>FUSE</strong>）是一个面向<a href="https://zh.wikipedia.org/wiki/类Unix" target="_blank" rel="noopener">类Unix</a>计算机<a href="https://zh.wikipedia.org/wiki/操作系统" target="_blank" rel="noopener">操作系统</a>的<a href="https://zh.wikipedia.org/wiki/应用程序接口" target="_blank" rel="noopener">软件接口</a>，它使无特权的用户能够无需编辑<a href="https://zh.wikipedia.org/wiki/内核" target="_blank" rel="noopener">内核</a>代码而创建自己的<a href="https://zh.wikipedia.org/wiki/文件系统" target="_blank" rel="noopener">文件系统</a>。当前<a href="https://zh.wikipedia.org/wiki/Linux" target="_blank" rel="noopener">Linux</a>通过<a href="https://zh.wikipedia.org/w/index.php?title=内核模块&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">内核模块</a>对此进行支持。一些文件系统如<a href="https://zh.wikipedia.org/wiki/ZFS" target="_blank" rel="noopener">ZFS</a>、<a href="https://zh.wikipedia.org/w/index.php?title=Glusterfs&amp;action=edit&amp;redlink=1" target="_blank" rel="noopener">glusterfs</a>和<a href="https://zh.wikipedia.org/wiki/Lustre" target="_blank" rel="noopener">lustre</a>使用FUSE实现。—— 维基百科</p>
<p>A filesystem in which data and metadata are provided by an ordinary userspace process. The filesystem can be accessed normally through the kernel interface. —— <a href="https://www.kernel.org/doc/html/latest/filesystems/fuse.html" target="_blank" rel="noopener">kernel.org</a></p>
</blockquote>
<p>简单来说就是一个让你能在用户态下实现文件系统的手段。</p>
<p>有了FUSE，制作一个在Unix-like操作系统中可用的文件系统不再需要进行“危险”、麻烦且需要大量前置知识的内核编程，当然，这也要付出一定的性能上的代价（但说实话，相比实际的磁盘IO甚至分布式文件系统中的网络IO时间，这一点进程间通信和切入切出内核的时间，who cares）。</p>
<h2 id="Success-Story"><a href="#Success-Story" class="headerlink" title="Success Story"></a>Success Story</h2><p>在这里列出几个我知道的使用了或者可以使用FUSE的文件系统：</p>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/SSHFS" target="_blank" rel="noopener">SSHFS</a>：通过SSH协议访问远程文件系统</li>
<li><a href="https://zh.wikipedia.org/wiki/ZFS" target="_blank" rel="noopener">ZFS</a>：传说中最好的文件系统<sup><a href="#fn_1" id="reffn_1">1</a></sup></li>
<li><a href="https://zh.wikipedia.org/wiki/NTFS-3G" target="_blank" rel="noopener">NTFS-3G</a>：通过FUSE实现在Unix-like操作系统上对NTFS文件系统的磁盘的写入</li>
<li><a href="https://zh.wikipedia.org/wiki/HDFS" target="_blank" rel="noopener">HDFS</a>: <a href="https://zh.wikipedia.org/wiki/Hadoop" target="_blank" rel="noopener">Hadoop</a>提供的分布式文件系统。</li>
</ul>
<h2 id="FUSE架构"><a href="#FUSE架构" class="headerlink" title="FUSE架构"></a>FUSE架构</h2><p>FUSE的架构是一个典型的client-server的架构：</p>
<p><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/08/FUSE_structure.svg/1920px-FUSE_structure.svg.png" alt="img"></p>
<p>在kernel中，FUSE服务器作为一个内核模块运行，其负责</p>
<ul>
<li>在文件系统的用户通过libc等方式访问通过FUSE挂载的文件系统上的文件时，监听来自VFS的处理请求（创建、读取、写入文件的请求），并将其转换为我们编写的FUSE deamon中的函数调用</li>
<li>FUSE deamon中的函数调用的结果（比如创建出来的文件的inode号等元信息）反馈给FUSE服务器，并由其转换为VFS可以理解的形式，并最终将信息反馈给文件系统的用户</li>
</ul>
<p>在用户空间中，对应的，我们使用<a href="https://github.com/libfuse/libfuse" target="_blank" rel="noopener">libfuse</a>，来为我们编写的FUSE deamon提供对FUSE服务器的访问接口。</p>
<p>当然，由于我们写的FUSE deamon不过是一个用户空间里的普通的程序，普通程序能做的事情他也能做，甚至包括通过其他文件系统打开文件<sup><a href="#fn_3" id="reffn_3">3</a></sup>。</p>
<h2 id="libfuse接口"><a href="#libfuse接口" class="headerlink" title="libfuse接口"></a>libfuse接口</h2><p>为了不致因为被野指针、各种编译和链接选项、未定义行为以及丑陋而又危险的“面向对象”操作搞疯掉<sup><a href="#fn_4" id="reffn_4">4</a></sup>，我决定使用<a href="https://github.com/zargony/fuse-rs" target="_blank" rel="noopener">libfuse的Rust绑定</a>，其他选项有：</p>
<ul>
<li><a href="https://github.com/bazil/fuse" target="_blank" rel="noopener">Go绑定</a></li>
<li><a href="https://github.com/kurozael/Fuse.NET" target="_blank" rel="noopener">C#绑定</a></li>
<li><a href="https://github.com/SerCeMan/jnr-fuse" target="_blank" rel="noopener">JVM绑定</a><sup><a href="#fn_5" id="reffn_5">5</a></sup></li>
<li><a href="https://github.com/m15k/hfuse" target="_blank" rel="noopener">Haskell绑定</a><sup><a href="#fn_6" id="reffn_6">6</a></sup></li>
<li>要是说你的C语言水平非常高超或者说我没有理由就是喜欢用C<sup><a href="#fn_7" id="reffn_7">7</a></sup>，那你直接用C的<a href="https://github.com/libfuse/libfuse" target="_blank" rel="noopener">libfuse</a>也可以</li>
<li>如果你知道怎么折腾链接的问题，那你可以用C++调C的<a href="https://github.com/libfuse/libfuse" target="_blank" rel="noopener">libfuse</a></li>
</ul>
<p>以下是libfuse中文件系统需要实现的trait（太长不看党可以直接跳过）：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">trait</span> <span class="title">Filesystem</span></span> &#123;</span><br><span class="line">    <span class="comment">/// 初始化文件系统</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">init</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;) -&gt; <span class="built_in">Result</span>&lt;(), c_int&gt; &#123;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 关闭文件系统</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">destroy</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 在文件夹中(ino=parent)中寻找一个文件名为name的文件</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">lookup</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, parent: <span class="built_in">u64</span>, name: &amp;OsStr, reply: ReplyEntry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// “忘记”一个inode</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">forget</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _nlookup: <span class="built_in">u64</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 获得文件的属性</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">getattr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, reply: ReplyAttr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 设置文件的属性</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">setattr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _mode: <span class="built_in">Option</span>&lt;<span class="built_in">u32</span>&gt;, _uid: <span class="built_in">Option</span>&lt;<span class="built_in">u32</span>&gt;, _gid: <span class="built_in">Option</span>&lt;<span class="built_in">u32</span>&gt;, _size: <span class="built_in">Option</span>&lt;<span class="built_in">u64</span>&gt;, _atime: <span class="built_in">Option</span>&lt;SystemTime&gt;, _mtime: <span class="built_in">Option</span>&lt;SystemTime&gt;, _fh: <span class="built_in">Option</span>&lt;<span class="built_in">u64</span>&gt;, _crtime: <span class="built_in">Option</span>&lt;SystemTime&gt;, _chgtime: <span class="built_in">Option</span>&lt;SystemTime&gt;, _bkuptime: <span class="built_in">Option</span>&lt;SystemTime&gt;, _flags: <span class="built_in">Option</span>&lt;<span class="built_in">u32</span>&gt;, reply: ReplyAttr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 读符号链接</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">readlink</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, reply: ReplyData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 创建文件inode</span></span><br><span class="line">    <span class="comment">/// 负责创建除文件夹外所有类型的“文件”</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">mknod</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _parent: <span class="built_in">u64</span>, _name: &amp;OsStr, _mode: <span class="built_in">u32</span>, _rdev: <span class="built_in">u32</span>, reply: ReplyEntry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 创建文件夹</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">mkdir</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _parent: <span class="built_in">u64</span>, _name: &amp;OsStr, _mode: <span class="built_in">u32</span>, reply: ReplyEntry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 删除文件</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">unlink</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _parent: <span class="built_in">u64</span>, _name: &amp;OsStr, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 删除文件夹</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">rmdir</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _parent: <span class="built_in">u64</span>, _name: &amp;OsStr, reply: ReplyEmpty);</span><br><span class="line">  </span><br><span class="line">    <span class="comment">/// 创建符号链接</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">symlink</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _parent: <span class="built_in">u64</span>, _name: &amp;OsStr, _link: &amp;Path, reply: ReplyEntry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 重命名文件</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">rename</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _parent: <span class="built_in">u64</span>, _name: &amp;OsStr, _newparent: <span class="built_in">u64</span>, _newname: &amp;OsStr, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 创建硬链接</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">link</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _newparent: <span class="built_in">u64</span>, _newname: &amp;OsStr, reply: ReplyEntry);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 打开文件</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">open</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _flags: <span class="built_in">u32</span>, reply: ReplyOpen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 读数据</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">read</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _offset: <span class="built_in">i64</span>, _size: <span class="built_in">u32</span>, reply: ReplyData);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 写数据</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">write</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _offset: <span class="built_in">i64</span>, _data: &amp;[<span class="built_in">u8</span>], _flags: <span class="built_in">u32</span>, reply: ReplyWrite);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// Flush</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">flush</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _lock_owner: <span class="built_in">u64</span>, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 关闭打开的文件</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">release</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _flags: <span class="built_in">u32</span>, _lock_owner: <span class="built_in">u64</span>, _flush: <span class="built_in">bool</span>, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 同步文件内容</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fsync</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _datasync: <span class="built_in">bool</span>, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 打开目录</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">opendir</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _flags: <span class="built_in">u32</span>, reply: ReplyOpen);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 读目录</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">readdir</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _offset: <span class="built_in">i64</span>, reply: ReplyDirectory);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 关闭目录</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">releasedir</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _flags: <span class="built_in">u32</span>, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 同步目录内容</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">fsyncdir</span> </span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _datasync: <span class="built_in">bool</span>, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 获得文件系统的信息</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">statfs</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, reply: ReplyStatfs);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 设置扩展信息</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">setxattr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _name: &amp;OsStr, _value: &amp;[<span class="built_in">u8</span>], _flags: <span class="built_in">u32</span>, _position: <span class="built_in">u32</span>, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 获取扩展信息</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">getxattr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _name: &amp;OsStr, _size: <span class="built_in">u32</span>, reply: ReplyXattr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 列出所有扩展信息的名字</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">listxattr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _size: <span class="built_in">u32</span>, reply: ReplyXattr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 删除扩展信息</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">removexattr</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _name: &amp;OsStr, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 检查文件访问许可</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">access</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _mask: <span class="built_in">u32</span>, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 创建并打开文件</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">create</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _parent: <span class="built_in">u64</span>, _name: &amp;OsStr, _mode: <span class="built_in">u32</span>, _flags: <span class="built_in">u32</span>, reply: ReplyCreate);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 测试 POSIX 文件锁</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">getlk</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _lock_owner: <span class="built_in">u64</span>, _start: <span class="built_in">u64</span>, _end: <span class="built_in">u64</span>, _typ: <span class="built_in">u32</span>, _pid: <span class="built_in">u32</span>, reply: ReplyLock);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 获取、修改或者释放 POSIX 文件锁</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">setlk</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _fh: <span class="built_in">u64</span>, _lock_owner: <span class="built_in">u64</span>, _start: <span class="built_in">u64</span>, _end: <span class="built_in">u64</span>, _typ: <span class="built_in">u32</span>, _pid: <span class="built_in">u32</span>, _sleep: <span class="built_in">bool</span>, reply: ReplyEmpty);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// 将文件内的块index映射到设备上的块号（需要'blkdev'选项）</span></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">bmap</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;, _ino: <span class="built_in">u64</span>, _blocksize: <span class="built_in">u32</span>, _idx: <span class="built_in">u64</span>, reply: ReplyBmap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中的<code>fh</code>可能需要解释一下，这个<code>fh</code>其实是<code>file_handle</code>（文件“句柄”，虽然这是个烂翻译），可以用这个<code>fh</code>来找到已经打开的，很可能被文件系统缓存在内存中的文件信息和元信息。</p>
<p>虽然说洋洋洒洒一大坨子函数看着让人心里犯怵，但是其实这些函数都是有默认实现的，也就是说，如果你用不到某个功能，你完全可以不实现它。</p>
<p>亲测得知<sup><a href="#fn_8" id="reffn_8">8</a></sup>：</p>
<ul>
<li><code>ls</code>需要<code>lookup</code>和<code>readdir</code></li>
<li><code>cat</code>需要<code>read</code></li>
<li><code>touch</code>需要<code>create</code></li>
<li>将结果通过<code>&gt;</code>符号写入文件需要<code>write</code>，如果是新建的文件需要<code>create</code></li>
<li>将结果通过<code>&gt;&gt;</code>追加到文件尾需要<code>write</code></li>
<li><code>mkdir</code>需要<code>mkdir</code></li>
<li>删除文件需要<code>unlink</code></li>
<li>删除文件夹需要<code>rmdir</code></li>
</ul>
<p>所以如果你想实现一个只读的文件系统，那么<code>lookup</code>、<code>readdir</code>、<code>read</code>就够了，要支持添加文件（夹），可以再追加<code>create</code>和<code>mkdir</code>等等，以此类推。</p>
<h2 id="如何访问磁盘"><a href="#如何访问磁盘" class="headerlink" title="如何访问磁盘"></a>如何访问磁盘</h2><p>在Unix-like的系统中，几乎所有东西都可以使用读写文件的方式来访问。</p>
<p>前面说过了，FUSE deamon不过是一个用户空间中的普通程序。</p>
<p>所以如果你想在你的FUSE deamon中访问磁盘，只需要对其对应的“文件”（常常位于<code>/dev</code>下）进行普通的文件读写（<code>read</code>、<code>write</code>、<code>seek</code>等system call即可），当然有可能你要用<code>chmod</code>修改这个“文件”的权限。</p>
<p>这么做的好处还有可以创建一个临时的img文件，来当作磁盘的mock来进行调试。</p>
<h2 id="demo"><a href="#demo" class="headerlink" title="demo"></a>demo</h2><h3 id="内部结构设计"><a href="#内部结构设计" class="headerlink" title="内部结构设计"></a>内部结构设计</h3><p>由于这不是介绍文件系统设计的文章<sup><a href="#fn_9" id="reffn_9">9</a></sup>，而重在展示FUSE的用法，故文件系统的设计以容易实现为第一要义。</p>
<p>目录结构采用简单粗暴的树的孩子-兄弟表示法。</p>
<p><img src="https://github.com/longfangsong/dumbfs/raw/master/readme/2.png" alt="2"></p>
<p>其中每个节点的结构如下：</p>
<p><img src="https://github.com/longfangsong/dumbfs/raw/master/readme/1.png" alt="1"></p>
<p>同时，我决定偷懒不实现删除和添加大于一个block大小的文件<sup><a href="#fn_10" id="reffn_10">10</a></sup>。</p>
<p>文件系统的元信息储存如下：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">DumbFsMeta</span></span> &#123;</span><br><span class="line">    <span class="comment">// magic number，用于判断挂载的磁盘是否已经被dumbfs格式化</span></span><br><span class="line">    <span class="keyword">pub</span> magic: <span class="built_in">u32</span>,</span><br><span class="line">  	<span class="comment">// 下一个可用的inode号</span></span><br><span class="line">    next_ino: <span class="built_in">u64</span>,</span><br><span class="line">    <span class="comment">// 下一个没有被分配出去的地址</span></span><br><span class="line">    <span class="keyword">pub</span> next_free_address: <span class="built_in">u64</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在磁盘中，第一个chunk用于存储这个元信息，其他chunk均用于存储文件节点。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><h4 id="文件在内存中的表示"><a href="#文件在内存中的表示" class="headerlink" title="文件在内存中的表示"></a>文件在内存中的表示</h4><figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 其实就是FUSE提供的FileAttr，但是那个没有实现Serialize和Deserialize所以不好Dump进磁盘</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">FileAttrDump</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> ino: <span class="built_in">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> size: <span class="built_in">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> blocks: <span class="built_in">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> atime: SystemTime,</span><br><span class="line">    <span class="keyword">pub</span> mtime: SystemTime,</span><br><span class="line">    <span class="keyword">pub</span> ctime: SystemTime,</span><br><span class="line">    <span class="keyword">pub</span> crtime: SystemTime,</span><br><span class="line">    <span class="keyword">pub</span> kind: FileTypeDump,</span><br><span class="line">    <span class="keyword">pub</span> perm: <span class="built_in">u16</span>,</span><br><span class="line">    <span class="keyword">pub</span> nlink: <span class="built_in">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> uid: <span class="built_in">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> gid: <span class="built_in">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> rdev: <span class="built_in">u32</span>,</span><br><span class="line">    <span class="keyword">pub</span> flags: <span class="built_in">u32</span>,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这部分会被dump到磁盘上</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">FileMeta</span></span> &#123;</span><br><span class="line">    <span class="keyword">pub</span> first_child: <span class="built_in">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> next_sibling: <span class="built_in">u64</span>,</span><br><span class="line">    <span class="keyword">pub</span> file_attr: FileAttrDump,</span><br><span class="line">    <span class="keyword">pub</span> filename: <span class="built_in">String</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 广义的文件，包括文件和目录</span></span><br><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">File</span></span> &#123;</span><br><span class="line">    address: <span class="built_in">u64</span>,				<span class="comment">// 文件在磁盘中的地址</span></span><br><span class="line">    cursor: <span class="built_in">u64</span>,				<span class="comment">// 当前读取到的位置</span></span><br><span class="line">    <span class="keyword">pub</span> meta: FileMeta,</span><br><span class="line">    disk: Disk, 				<span class="comment">// Disk 是File的别名</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Seek <span class="keyword">for</span> File &#123;</span><br><span class="line">    <span class="comment">// 略，你自己能想到的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Read <span class="keyword">for</span> File &#123;</span><br><span class="line">    <span class="comment">// 略，你自己能想到的</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> Write <span class="keyword">for</span> File &#123;</span><br><span class="line">	<span class="comment">// 略，你自己能想到的，别忘了写完可能要重新计算meta.file_attr.size</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同时为了方便访问文件/目录的孩子与兄弟，我也实现了文件的迭代器：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="class"><span class="keyword">struct</span> <span class="title">FileIterator</span></span> &#123;</span><br><span class="line">    address: <span class="built_in">Option</span>&lt;<span class="built_in">u64</span>&gt;,</span><br><span class="line">    disk: Disk,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> <span class="built_in">Iterator</span> <span class="keyword">for</span> FileIterator &#123;</span><br><span class="line">    <span class="class"><span class="keyword">type</span> <span class="title">Item</span></span> = File;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fn</span> <span class="title">next</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) -&gt; <span class="built_in">Option</span>&lt;Self::Item&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(address) = <span class="keyword">self</span>.address &#123;</span><br><span class="line">            <span class="keyword">let</span> this_file = File::load(&amp;<span class="keyword">self</span>.disk, address).unwrap();</span><br><span class="line">            <span class="keyword">self</span>.address = <span class="keyword">if</span> this_file.meta.next_sibling == <span class="number">0</span> &#123;</span><br><span class="line">                <span class="literal">None</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="literal">Some</span>(this_file.meta.next_sibling)</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="literal">Some</span>(this_file)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="literal">None</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">impl</span> File &#123;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">children</span></span>(&amp;<span class="keyword">self</span>) -&gt; FileIterator;</span><br><span class="line">    <span class="keyword">pub</span> <span class="function"><span class="keyword">fn</span> <span class="title">siblings</span></span>(&amp;<span class="keyword">self</span>) -&gt; FileIterator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="文件系统的实现"><a href="#文件系统的实现" class="headerlink" title="文件系统的实现"></a>文件系统的实现</h3><h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><p>检查一下盘里面的meta信息是否valid，不valid就“格式化”磁盘：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">init_filesystem</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>) &#123;</span><br><span class="line">        info!(<span class="string">"init filesystem"</span>);</span><br><span class="line">        <span class="keyword">self</span>.meta = DumbFsMeta::<span class="keyword">default</span>();</span><br><span class="line">        <span class="keyword">let</span> ino = <span class="keyword">self</span>.meta.acquire_next_ino();</span><br><span class="line">        <span class="built_in">assert_eq!</span>(ino, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">let</span> root_dir = FileBuilder::new(&amp;<span class="keyword">self</span>.disk, <span class="keyword">self</span>.meta.next_free_address)</span><br><span class="line">            .ino(ino)</span><br><span class="line">            .build();</span><br><span class="line">        <span class="keyword">self</span>.meta.next_free_address += <span class="number">512</span>;</span><br><span class="line">        root_dir.sync(&amp;<span class="keyword">self</span>.disk);</span><br><span class="line">        <span class="keyword">self</span>.meta.sync(&amp;<span class="keyword">self</span>.disk);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">init</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request&lt;<span class="symbol">'_</span>&gt;) -&gt; <span class="built_in">Result</span>&lt;(), <span class="built_in">i32</span>&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> meta = DumbFsMeta::load(&amp;<span class="keyword">self</span>.disk, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">match</span> meta &#123;</span><br><span class="line">            <span class="literal">Ok</span>(meta) =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> meta.valid() &#123;</span><br><span class="line">                    <span class="keyword">self</span>.meta = meta</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">self</span>.init_filesystem();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="literal">Err</span>(_) =&gt; <span class="keyword">self</span>.init_filesystem(),</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="literal">Ok</span>(())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="lookup"><a href="#lookup" class="headerlink" title="lookup"></a>lookup</h4><p>直接查看<code>parent</code>的<code>children</code>中有没有你想要的那个即可，找到parent的方式是简单的DFS搜索（讲道理可以配个缓存上去）：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">find_file_with_root</span></span>(&amp;<span class="keyword">self</span>, ino: <span class="built_in">u64</span>, root: File) -&gt; <span class="built_in">Option</span>&lt;File&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> kind = root.meta.file_attr.kind.clone();</span><br><span class="line">        <span class="keyword">match</span> kind &#123;</span><br><span class="line">            FileTypeDump::Directory =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> root.meta.file_attr.ino == ino &#123;</span><br><span class="line">                    <span class="literal">Some</span>(root)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    root.children()</span><br><span class="line">                        .find_map(|it| <span class="keyword">self</span>.find_file_with_root(ino, it))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            FileTypeDump::RegularFile =&gt; &#123;</span><br><span class="line">                <span class="keyword">if</span> root.meta.file_attr.ino == ino &#123;</span><br><span class="line">                    <span class="literal">Some</span>(root)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="literal">None</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"> &#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">find_file</span></span>(&amp;<span class="keyword">self</span>, ino: <span class="built_in">u64</span>) -&gt; <span class="built_in">Option</span>&lt;File&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> root = File::load(&amp;<span class="keyword">self</span>.disk, <span class="number">512</span>).unwrap();</span><br><span class="line">    <span class="built_in">assert_eq!</span>(root.meta.file_attr.ino, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">lookup</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request, parent: <span class="built_in">u64</span>, name: &amp;OsStr, reply: ReplyEntry) &#123;</span><br><span class="line">    debug!(<span class="string">"lookup &#123;:?&#125; in ino=&#123;&#125;"</span>, name, parent);</span><br><span class="line">    <span class="keyword">let</span> parent = <span class="keyword">self</span>.find_file(parent);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(parent) = parent &#123;</span><br><span class="line">        <span class="keyword">let</span> found = parent</span><br><span class="line">                .children()</span><br><span class="line">                .find(|it| name.to_str().unwrap() == it.meta.filename);</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(found) = found &#123;</span><br><span class="line">                reply.entry(&amp;TTL, &amp;found.meta.file_attr.into(), <span class="number">1</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                reply.error(ENOENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reply.error(ENOENT)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="文件操作"><a href="#文件操作" class="headerlink" title="文件操作"></a>文件操作</h4><h5 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h5><p>建立一个新文件，并将其放在最后的空位子上，然后将为他的父亲或者兄弟和他链接上。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">create</span></span>(</span><br><span class="line">        &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">        _req: &amp;Request,</span><br><span class="line">        parent: <span class="built_in">u64</span>,</span><br><span class="line">        name: &amp;OsStr,</span><br><span class="line">        _mode: <span class="built_in">u32</span>,</span><br><span class="line">        flags: <span class="built_in">u32</span>,</span><br><span class="line">        reply: ReplyCreate,</span><br><span class="line">    ) &#123;</span><br><span class="line">        <span class="keyword">let</span> parent = <span class="keyword">self</span>.find_file(parent);</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(<span class="keyword">mut</span> parent) = parent &#123;</span><br><span class="line">            <span class="keyword">if</span> parent.meta.file_attr.kind != FileTypeDump::Directory &#123;</span><br><span class="line">                reply.error(EIO);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> at_address = <span class="keyword">self</span>.meta.next_free_address;</span><br><span class="line">                <span class="keyword">let</span> new_created = FileBuilder::new(&amp;<span class="keyword">self</span>.disk, at_address)</span><br><span class="line">                    .ino(<span class="keyword">self</span>.meta.acquire_next_ino())</span><br><span class="line">                    .kind(FileTypeDump::RegularFile.into())</span><br><span class="line">                    .filename(name.to_str().unwrap())</span><br><span class="line">                    .build();</span><br><span class="line">                new_created.sync(&amp;<span class="keyword">self</span>.disk);</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(<span class="keyword">mut</span> last_child) = parent.children().last() &#123;</span><br><span class="line">                    last_child.meta.next_sibling = at_address;</span><br><span class="line">                    last_child.sync(&amp;<span class="keyword">self</span>.disk)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    parent.meta.first_child = at_address;</span><br><span class="line">                    parent.sync(&amp;<span class="keyword">self</span>.disk);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">self</span>.meta.next_free_address = align(new_created.address_after_dump(), <span class="number">512</span>);</span><br><span class="line">                <span class="keyword">self</span>.meta.sync(&amp;<span class="keyword">self</span>.disk);</span><br><span class="line">                <span class="keyword">let</span> fh = <span class="keyword">self</span>.next_file_handler;</span><br><span class="line">                <span class="keyword">self</span>.next_file_handler += <span class="number">1</span>;</span><br><span class="line">                reply.created(</span><br><span class="line">                    &amp;TTL,</span><br><span class="line">                    &amp;new_created.meta.file_attr.clone().into(),</span><br><span class="line">                    <span class="number">1</span>,</span><br><span class="line">                    fh,</span><br><span class="line">                    flags,</span><br><span class="line">                );</span><br><span class="line">                <span class="keyword">self</span>.opened_files.insert(fh, new_created);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reply.error(ENOENT);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="打开"><a href="#打开" class="headerlink" title="打开"></a>打开</h5><p>大概就是把文件找出来然后将其和一个<code>fh</code>关联，然后将这个文件放在缓存中（我的实现里是一个<code>HashMap</code>）。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">open</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request, ino: <span class="built_in">u64</span>, _flags: <span class="built_in">u32</span>, reply: ReplyOpen) &#123;</span><br><span class="line">        <span class="keyword">let</span> file = <span class="keyword">self</span>.find_file(ino);</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(file) = file &#123;</span><br><span class="line">            <span class="keyword">let</span> fh = <span class="keyword">self</span>.next_file_handler;</span><br><span class="line">            <span class="keyword">self</span>.next_file_handler += <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">self</span>.opened_files.insert(fh, file);</span><br><span class="line">            info!(<span class="string">"open ino=&#123;&#125;, return fh=&#123;&#125;"</span>, ino, fh);</span><br><span class="line">            reply.opened(fh, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            reply.error(ENOENT)</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="读写"><a href="#读写" class="headerlink" title="读写"></a>读写</h5><p>根据<code>fh</code>找到文件然后直接调用文件的读写功能就好了。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">read</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    _req: &amp;Request,</span><br><span class="line">    _ino: <span class="built_in">u64</span>,</span><br><span class="line">    fh: <span class="built_in">u64</span>,</span><br><span class="line">    offset: <span class="built_in">i64</span>,</span><br><span class="line">    size: <span class="built_in">u32</span>,</span><br><span class="line">    reply: ReplyData,</span><br><span class="line">) &#123;</span><br><span class="line">    info!(<span class="string">"read with fh=&#123;&#125;"</span>, fh);</span><br><span class="line">    <span class="keyword">let</span> file = <span class="keyword">self</span>.opened_files.get_mut(&amp;fh);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(file) = file &#123;</span><br><span class="line">        <span class="keyword">let</span> <span class="keyword">mut</span> buffer = <span class="built_in">vec!</span>[<span class="number">0u8</span>; size <span class="keyword">as</span> <span class="built_in">usize</span>];</span><br><span class="line">        file.seek(SeekFrom::Start(offset <span class="keyword">as</span> _)).unwrap();</span><br><span class="line">        file.read_exact(&amp;<span class="keyword">mut</span> buffer).unwrap();</span><br><span class="line">        reply.data(&amp;buffer)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reply.error(EIO)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">write</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    _req: &amp;Request,</span><br><span class="line">    _ino: <span class="built_in">u64</span>,</span><br><span class="line">    fh: <span class="built_in">u64</span>,</span><br><span class="line">    offset: <span class="built_in">i64</span>,</span><br><span class="line">    data: &amp;[<span class="built_in">u8</span>],</span><br><span class="line">    _flags: <span class="built_in">u32</span>,</span><br><span class="line">    reply: ReplyWrite,</span><br><span class="line">) &#123;</span><br><span class="line">    info!(<span class="string">"write into fh=&#123;&#125;"</span>, fh);</span><br><span class="line">    <span class="keyword">let</span> file = <span class="keyword">self</span>.opened_files.get_mut(&amp;fh);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(file) = file &#123;</span><br><span class="line">        file.seek(SeekFrom::Start(offset <span class="keyword">as</span> _)).unwrap();</span><br><span class="line">        file.write_all(data).unwrap();</span><br><span class="line">        reply.written(data.len() <span class="keyword">as</span> _)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reply.error(EIO)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="关闭"><a href="#关闭" class="headerlink" title="关闭"></a>关闭</h5><p>把<code>fh</code>和文件的关联从map里拿掉：</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">release</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    _req: &amp;Request,</span><br><span class="line">    _ino: <span class="built_in">u64</span>,</span><br><span class="line">    fh: <span class="built_in">u64</span>,</span><br><span class="line">    _flags: <span class="built_in">u32</span>,</span><br><span class="line">    _lock_owner: <span class="built_in">u64</span>,</span><br><span class="line">    _flush: <span class="built_in">bool</span>,</span><br><span class="line">    reply: ReplyEmpty,</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">if</span> !<span class="keyword">self</span>.opened_files.contains_key(&amp;fh) &#123;</span><br><span class="line">        <span class="keyword">return</span> reply.error(EIO);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">self</span>.opened_files.remove(&amp;fh);</span><br><span class="line">    reply.ok()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="文件夹操作"><a href="#文件夹操作" class="headerlink" title="文件夹操作"></a>文件夹操作</h4><p>基本上和文件操作差不多。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">opendir</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request, ino: <span class="built_in">u64</span>, flags: <span class="built_in">u32</span>, reply: ReplyOpen) &#123;</span><br><span class="line">    info!(<span class="string">"opendir: &#123;&#125;"</span>, ino);</span><br><span class="line">    <span class="keyword">let</span> file = <span class="keyword">self</span>.find_file(ino);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(file) = file &#123;</span><br><span class="line">        <span class="keyword">let</span> fh = <span class="keyword">self</span>.next_file_handler;</span><br><span class="line">        <span class="keyword">self</span>.next_file_handler += <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">self</span>.opened_files.insert(fh, file);</span><br><span class="line">        reply.opened(fh, flags);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reply.error(ENOENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">readdir</span></span>(</span><br><span class="line">    &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">    _req: &amp;Request,</span><br><span class="line">    _ino: <span class="built_in">u64</span>,</span><br><span class="line">    fh: <span class="built_in">u64</span>,</span><br><span class="line">    offset: <span class="built_in">i64</span>,</span><br><span class="line">    <span class="keyword">mut</span> reply: ReplyDirectory,</span><br><span class="line">) &#123;</span><br><span class="line">    <span class="keyword">let</span> dir = <span class="keyword">self</span>.opened_files.get(&amp;fh);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(dir) = dir &#123;</span><br><span class="line">        <span class="keyword">for</span> (i, entry) <span class="keyword">in</span> dir.children().enumerate().skip(offset <span class="keyword">as</span> _) &#123;</span><br><span class="line">            <span class="keyword">if</span> reply.add(</span><br><span class="line">                entry.meta.file_attr.ino,</span><br><span class="line">                (i + <span class="number">1</span>) <span class="keyword">as</span> <span class="built_in">i64</span>,</span><br><span class="line">                entry.meta.file_attr.kind.into(),</span><br><span class="line">                &amp;entry.meta.filename,</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        reply.ok()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reply.error(EIO)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">releasedir</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request, _ino: <span class="built_in">u64</span>, fh: <span class="built_in">u64</span>, _flags: <span class="built_in">u32</span>, reply: ReplyEmpty) &#123;</span><br><span class="line">    <span class="keyword">if</span> !<span class="keyword">self</span>.opened_files.contains_key(&amp;fh) &#123;</span><br><span class="line">        <span class="keyword">return</span> reply.error(EIO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">self</span>.opened_files.remove(&amp;fh);</span><br><span class="line">    reply.ok();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">mkdir</span></span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, _req: &amp;Request, parent: <span class="built_in">u64</span>, name: &amp;OsStr, _mode: <span class="built_in">u32</span>, reply: ReplyEntry) &#123;</span><br><span class="line">    <span class="keyword">let</span> parent = <span class="keyword">self</span>.find_file(parent);</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(<span class="keyword">mut</span> parent) = parent &#123;</span><br><span class="line">        <span class="keyword">if</span> parent.meta.file_attr.kind != FileTypeDump::Directory &#123;</span><br><span class="line">            reply.error(EIO);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> at_address = <span class="keyword">self</span>.meta.next_free_address;</span><br><span class="line">            <span class="keyword">let</span> new_created = FileBuilder::new(&amp;<span class="keyword">self</span>.disk, at_address)</span><br><span class="line">                .ino(<span class="keyword">self</span>.meta.acquire_next_ino())</span><br><span class="line">                .kind(FileTypeDump::Directory.into())</span><br><span class="line">                .filename(name.to_str().unwrap())</span><br><span class="line">                .build();</span><br><span class="line">            new_created.sync(&amp;<span class="keyword">self</span>.disk);</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> <span class="literal">Some</span>(<span class="keyword">mut</span> last_child) = parent.children().last() &#123;</span><br><span class="line">                last_child.meta.next_sibling = at_address;</span><br><span class="line">                last_child.sync(&amp;<span class="keyword">self</span>.disk)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                parent.meta.first_child = at_address;</span><br><span class="line">                parent.sync(&amp;<span class="keyword">self</span>.disk);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">self</span>.meta.next_free_address = align(new_created.address_after_dump(), <span class="number">512</span>);</span><br><span class="line">            <span class="keyword">self</span>.meta.sync(&amp;<span class="keyword">self</span>.disk);</span><br><span class="line">            <span class="keyword">let</span> fh = <span class="keyword">self</span>.next_file_handler;</span><br><span class="line">            <span class="keyword">self</span>.next_file_handler += <span class="number">1</span>;</span><br><span class="line">            reply.entry(&amp;TTL, &amp;new_created.meta.file_attr.clone().into(), <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">self</span>.opened_files.insert(fh, new_created);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        reply.error(ENOENT);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="main"><a href="#main" class="headerlink" title="main"></a>main</h4><p>解析参数，然后挂载。</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fn</span> <span class="title">main</span></span>() &#123;</span><br><span class="line">    env_logger::init();</span><br><span class="line">    <span class="keyword">let</span> disk = env::args_os().nth(<span class="number">1</span>).unwrap();</span><br><span class="line">    <span class="keyword">let</span> mountpoint = env::args_os().nth(<span class="number">2</span>).unwrap();</span><br><span class="line">    info!(<span class="string">"mount: &#123;:?&#125; on &#123;:?&#125;"</span>, disk, mountpoint);</span><br><span class="line">    <span class="keyword">let</span> options = [<span class="string">"-o"</span>, <span class="string">"rw,default_permissions"</span>, <span class="string">"-o"</span>, <span class="string">"fsname=dumbfs"</span>]</span><br><span class="line">        .iter()</span><br><span class="line">        .map(|o| o.as_ref())</span><br><span class="line">        .collect::&lt;<span class="built_in">Vec</span>&lt;&amp;OsStr&gt;&gt;();</span><br><span class="line">    <span class="keyword">let</span> dumbfs = DumbFS::new(disk);</span><br><span class="line">    fuse::mount(dumbfs, mountpoint, &amp;options).unwrap();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此，我们就有了一个支持基本功能的文件系统了。</p>
<h3 id="试一试"><a href="#试一试" class="headerlink" title="试一试"></a>试一试</h3><p>这是一个U盘：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  /tmp diskutil list</span><br><span class="line">......</span><br><span class="line">/dev/disk2 (external, physical):</span><br><span class="line"><span class="meta">   #</span><span class="bash">:                       TYPE NAME                    SIZE       IDENTIFIER</span></span><br><span class="line">   0:                                                   *4.0 GB     disk2</span><br></pre></td></tr></table></figure>
<p>先给权限：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod 777 /dev/disk2</span><br></pre></td></tr></table></figure>
<p>然后用我们的程序来把它挂载起来：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dumbfs /dev/disk2 /tmp/test</span><br></pre></td></tr></table></figure>
<p>进入挂载到的目录:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">➜  /tmp cd ./test</span><br><span class="line">➜  test ls -al</span><br><span class="line">total 0</span><br><span class="line">drwxrwxrwx   0 root  wheel    0  3 23 13:30 .</span><br><span class="line">drwxrwxrwt  17 root  wheel  544  3 23 13:30 ..</span><br></pre></td></tr></table></figure>
<p>试一试一些基本操作：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">➜  test echo "Hello world" &gt; ./1.txt</span><br><span class="line">➜  test cat 1.txt </span><br><span class="line">Hello world</span><br><span class="line">➜  test ls -al</span><br><span class="line">total 8</span><br><span class="line">drwxrwxrwx   0 root  wheel    0  3 23 13:30 .</span><br><span class="line">drwxrwxrwt  17 root  wheel  544  3 23 13:30 ..</span><br><span class="line">-rwxrwxrwx   0 root  wheel   12  3 23 13:31 1.txt</span><br><span class="line">➜  test mkdir dir1</span><br><span class="line">➜  test echo "Hello world" &gt; ./dir1/1.txt</span><br><span class="line">➜  test cat ./dir1/1.txt </span><br><span class="line">Hello world</span><br><span class="line">➜  test echo "Bye" &gt;&gt; ./dir1/1.txt </span><br><span class="line">➜  test cat ./dir1/1.txt          </span><br><span class="line">Hello world</span><br><span class="line">Bye</span><br><span class="line">➜  test ls -al</span><br><span class="line">total 8</span><br><span class="line">drwxrwxrwx   0 root  wheel    0  3 23 13:30 .</span><br><span class="line">drwxrwxrwt  17 root  wheel  544  3 23 13:31 ..</span><br><span class="line">-rwxrwxrwx   0 root  wheel   12  3 23 13:31 1.txt</span><br><span class="line">drwxrwxrwx   0 root  wheel    0  3 23 13:31 dir1</span><br><span class="line">➜  test ls -al ./dir1 </span><br><span class="line">total 8</span><br><span class="line">drwxrwxrwx  0 root  wheel   0  3 23 13:31 .</span><br><span class="line">drwxrwxrwx  0 root  wheel   0  3 23 13:30 ..</span><br><span class="line">-rwxrwxrwx  0 root  wheel  16  3 23 13:31 1.txt</span><br></pre></td></tr></table></figure>
<p>看起来能用了，舒服。</p>
<p>把磁盘里的块<code>dd</code>出来看下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo dd if=/dev/disk2 of=/tmp/1.dmg count=10</span><br></pre></td></tr></table></figure>
<p><img src="/2020/03/23/用FUSE构建你自己的文件系统/屏幕快照 2020-03-23 下午2.03.56.png" alt="屏幕快照 2020-03-23 下午2.03.56"></p>
<p>可见数据确实是存在了这个块设备上了。</p>
<h2 id="Future-works"><a href="#Future-works" class="headerlink" title="Future works"></a>Future works</h2><p>未来我会考虑：</p>
<ul>
<li>由于FUSE deamon是一个普通的用户态程序，其访问Internet也是很方便的，因此可以对接某些云存储厂商，将云存储挂载到本地使用</li>
<li>将多个存储设备挂载到单个目录上，组软RAID</li>
</ul>
<blockquote id="fn_1">
<sup>1</sup>. 当然我不这么认为，世界上最好的文件系统应该在所有的操作系统上只用一个命令就装好了<a href="#reffn_1" title="Jump back to footnote [1] in the text."> &#8617;</a>
</blockquote>
<blockquote id="fn_3">
<sup>3</sup>. 有没有人想玩套娃的😄<a href="#reffn_3" title="Jump back to footnote [3] in the text."> &#8617;</a>
</blockquote>
<blockquote id="fn_4">
<sup>4</sup>. 阴 阳 怪 气：都0202年了，不会真的有人写用户态的东西用C语言的吧<a href="#reffn_4" title="Jump back to footnote [4] in the text."> &#8617;</a>
</blockquote>
<blockquote id="fn_6">
<sup>6</sup>. 想不到吧.jpg<a href="#reffn_6" title="Jump back to footnote [6] in the text."> &#8617;</a>
</blockquote>
<blockquote id="fn_7">
<sup>7</sup>. 你是人吗？（两种意义）<a href="#reffn_7" title="Jump back to footnote [7] in the text."> &#8617;</a>
</blockquote>
<blockquote id="fn_8">
<sup>8</sup>. 可能不完整，建议你自己试一试<a href="#reffn_8" title="Jump back to footnote [8] in the text."> &#8617;</a>
</blockquote>
<blockquote id="fn_10">
<sup>10</sup>. 这也太偷懒了吧，其实我自己也这么觉得，可是我明天就要研讨了……<a href="#reffn_10" title="Jump back to footnote [10] in the text."> &#8617;</a>
</blockquote>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2020-03-23</span><i class="fa fa-tag"></i><a class="tag" href="/tags/文件系统/" title="文件系统">文件系统 </a><a class="tag" href="/tags/操作系统/" title="操作系统">操作系统 </a><a class="tag" href="/tags/Rust/" title="Rust">Rust </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://longfangsong.github.io/2020/03/23/用FUSE构建你自己的文件系统/,Blog,用FUSE构建你自己的文件系统,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="next pagbuttons"><a class="btn" role="navigation" href="/2020/03/18/Bigtable简介/" title="Bigtable简介">下一篇</a></li></ul></div><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:false || false,
  verify:false|| false,
  app_id:'HcCTt2sXmRChcaE4nMoSibwJ-gzGzoHsz',
  app_key:'6eevqWRr7jsWPUavkkAQjIMi',
  placeholder:'随便说点啥吧……',
  path: window.location.pathname,
  avatar:'mm'
})</script></div></div></div></div><script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script src="https://cdn.bootcss.com/jquery-migrate/3.0.1/jquery-migrate.min.js"></script><script src="https://cdn.bootcss.com/jquery.appear/0.3.6/jquery.appear.min.js"></script></body></html>